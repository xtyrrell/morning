{{ 'section-about-split.css' | asset_url | stylesheet_tag }}

{%- style -%}
  .section-{{ section.id }}-padding {
    padding-top: 0;
    padding-bottom: 0;
  }
{%- endstyle -%}

<div id="about" class="about-split section-{{ section.id }}-padding gradient color-{{ section.settings.color_scheme }}">
  <div class="about-split__grid">
    <div class="about-split__media-wrapper">
        <div class="about-split__media-list">
          <div class="about-split__media-item">
            <img
              src="{{ '_DSC6264-1.jpg' | asset_url }}"
              alt="{{ page.title | default: section.settings.heading | default: 'About' | escape }}"
              loading="eager"
              width="1200"
              height="800"
            >
          </div>
          <div class="about-split__media-item">
            <img
              src="{{ '_DSC9238.jpg' | asset_url }}"
              alt="{{ page.title | default: 'About' | escape }}"
              loading="lazy"
              width="1200"
              height="800"
            >
          </div>
          <div class="about-split__media-item">
            <img
              src="{{ 'IMG_8203-copy.jpg' | asset_url }}"
              alt="{{ page.title | default: 'About' | escape }}"
              loading="lazy"
              width="1200"
              height="800"
            >
          </div>
        </div>
    </div>
    <div class="about-split__content-wrapper">
      <div class="about-split__content">
        <h1 class="about-split__title h0">
          {{ page.title | default: section.settings.heading | escape }}
        </h1>
        <div class="about-split__text rte">
          {{ page.content | default: section.settings.text }}
        </div>
      </div>
    </div>
  </div>
</div>

<div class="about-split__fullscreen" id="about-split-fullscreen-{{ section.id }}" role="button" tabindex="-1" aria-label="Close">
  <button type="button" class="about-split__fullscreen-back" id="about-split-fullscreen-back-{{ section.id }}" aria-label="Back">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M19 12H5M12 19l-7-7 7-7"/>
    </svg>
  </button>
  <div class="about-split__fullscreen-dots" id="about-split-fullscreen-dots-{{ section.id }}" aria-hidden="true">
    <!-- Filled by JS: one dot per image -->
  </div>
  <div class="about-split__fullscreen-scroll" id="about-split-fullscreen-scroll-{{ section.id }}">
    <!-- Filled by JS from about section images -->
  </div>
</div>

<script>
  (function() {
    var sectionId = '{{ section.id }}';
    var fullscreen = document.getElementById('about-split-fullscreen-' + sectionId);
    var scrollEl = document.getElementById('about-split-fullscreen-scroll-' + sectionId);
    var container = document.getElementById('about');
    if (!fullscreen || !scrollEl || !container) return;

    var mediaWrapper = container.querySelector('.about-split__media-wrapper');
    var mediaItems = Array.from(container.querySelectorAll('.about-split__media-item'));
    var images = container.querySelectorAll('.about-split__media-item img');
    var imageList = [];

    images.forEach(function(img) {
      var item = document.createElement('div');
      item.className = 'about-split__fullscreen-item';
      var clone = document.createElement('img');
      clone.src = img.currentSrc || img.getAttribute('src');
      if (img.srcset) clone.srcset = img.srcset;
      if (img.sizes) clone.sizes = img.sizes;
      clone.alt = img.alt || '';
      item.appendChild(clone);
      scrollEl.appendChild(item);
      imageList.push({ item: item, img: img });
    });

    /* Main-view dots (above images, product-style) - only when multiple images */
    var mainDotsContainer = null;
    if (mediaItems.length > 1) {
      var existingMainDots = container.querySelector('.prada-nav-dots');
      if (existingMainDots) existingMainDots.remove();
      mainDotsContainer = document.createElement('div');
      mainDotsContainer.className = 'prada-nav-dots';
      mediaItems.forEach(function(item, index) {
        var dot = document.createElement('span');
        if (index === 0) dot.classList.add('active');
        dot.setAttribute('role', 'button');
        dot.setAttribute('aria-label', 'Go to image ' + (index + 1));
        dot.dataset.index = index;
        dot.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          var idx = parseInt(dot.dataset.index, 10);
          var el = mediaItems[idx];
          if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
        });
        mainDotsContainer.appendChild(dot);
      });
      container.appendChild(mainDotsContainer);

      var defaultBottomRem = 32;
      function updateMainDotsPosition() {
        if (!mainDotsContainer || !mediaWrapper) return;
        var rect = mediaWrapper.getBoundingClientRect();
        var viewportBottom = window.innerHeight;
        var sectionBottom = rect.bottom;
        var minAboveSectionBottom = defaultBottomRem;
        var bottomIfConstrained = viewportBottom - sectionBottom + minAboveSectionBottom;
        mainDotsContainer.style.bottom = Math.max(defaultBottomRem, bottomIfConstrained) + 'px';
        mainDotsContainer.style.visibility = (rect.bottom < 0 || rect.top > viewportBottom || fullscreen.classList.contains('is-open')) ? 'hidden' : 'visible';
      }
      updateMainDotsPosition();
      window.addEventListener('scroll', updateMainDotsPosition, { passive: true });
      window.addEventListener('resize', updateMainDotsPosition);

      function updateMainDotsActive() {
        if (!mainDotsContainer || fullscreen.classList.contains('is-open')) return;
        var viewportMid = window.innerHeight / 2;
        var activeIndex = 0;
        var minDist = Infinity;
        mediaItems.forEach(function(item, index) {
          var r = item.getBoundingClientRect();
          var mid = r.top + r.height / 2;
          var dist = Math.abs(mid - viewportMid);
          if (dist < minDist) {
            minDist = dist;
            activeIndex = index;
          }
        });
        mainDotsContainer.querySelectorAll('span').forEach(function(dot, i) {
          dot.classList.toggle('active', i === activeIndex);
        });
      }
      updateMainDotsActive();
      window.addEventListener('scroll', updateMainDotsActive, { passive: true });
    }

    var dotsEl = document.getElementById('about-split-fullscreen-dots-' + sectionId);
    if (dotsEl && imageList.length > 1) {
      var dotsFragment = document.createDocumentFragment();
      for (var i = 0; i < imageList.length; i++) {
        var dot = document.createElement('span');
        if (i === 0) dot.classList.add('active');
        dot.setAttribute('role', 'button');
        dot.setAttribute('aria-label', 'Go to image ' + (i + 1));
        dot.dataset.index = i;
        dotsFragment.appendChild(dot);
      }
      dotsEl.appendChild(dotsFragment);
      dotsEl.querySelectorAll('span').forEach(function(dot) {
        dot.addEventListener('click', function(e) {
          e.stopPropagation();
          var idx = parseInt(dot.dataset.index, 10);
          scrollToSlide(idx);
          updateDots(idx);
        });
      });
    }

    function updateDots(activeIndex) {
      if (!dotsEl) return;
      dotsEl.querySelectorAll('span').forEach(function(dot, i) {
        dot.classList.toggle('active', i === activeIndex);
      });
    }

    function scrollToSlide(index) {
      index = Math.max(0, Math.min(index, imageList.length - 1));
      var top = index * scrollEl.clientHeight;
      scrollEl.scrollTo({ top: top, behavior: 'smooth' });
      updateDots(index);
    }

    function getCurrentSlideIndex() {
      var scrollTop = scrollEl.scrollTop;
      var index = Math.round(scrollTop / scrollEl.clientHeight);
      return Math.min(index, imageList.length - 1);
    }

    images.forEach(function(img, index) {
      img.addEventListener('dblclick', function(e) {
        e.preventDefault();
        e.stopPropagation();
        fullscreen.classList.add('is-open');
        document.body.style.overflow = 'hidden';
        if (mainDotsContainer) mainDotsContainer.style.visibility = 'hidden';
        scrollToSlide(index);
        updateDots(index);
      });
    });

    scrollEl.addEventListener('scroll', function() {
      if (!fullscreen.classList.contains('is-open')) return;
      updateDots(getCurrentSlideIndex());
    });

    function closeFullscreen() {
      fullscreen.classList.remove('is-open');
      document.body.style.overflow = '';
      if (mainDotsContainer) mainDotsContainer.style.visibility = '';
    }

    fullscreen.addEventListener('click', function(e) {
      if (e.target === fullscreen) closeFullscreen();
    });
    var backBtn = document.getElementById('about-split-fullscreen-back-' + sectionId);
    if (backBtn) backBtn.addEventListener('click', function(e) { e.stopPropagation(); closeFullscreen(); });
    scrollEl.addEventListener('click', function(e) {
      e.stopPropagation();
    });
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && fullscreen.classList.contains('is-open')) closeFullscreen();
    });
  })();
</script>

{% schema %}
{
  "name": "About (split)",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "image_picker",
      "id": "image",
      "label": "Image (left side)"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading (fallback if no page title)"
    },
    {
      "type": "richtext",
      "id": "text",
      "label": "Text (fallback if no page content)"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "Color scheme",
      "default": "scheme-1"
    }
  ],
  "presets": [
    {
      "name": "About (split)",
      "settings": {
        "image": "shopify://shop_images/B016522B-D335-43BF-8F22-5CC986817E2A.jpg",
        "heading": "About",
        "color_scheme": "scheme-1"
      }
    }
  ]
}
{% endschema %}
